{% load static %}
<!DOCTYPE html>
<html lang="pt-br" class="h-full bg-gray-950">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ titulo }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        .form-control, select, input[type="text"], input[type="date"], input[type="time"], textarea {
            background-color: #334155; border-color: #475569; color: #e2e8f0;
            border-radius: 0.375rem; padding: 0.5rem; width: 100%; display: block;
        }
        .form-control:focus { outline: 2px solid #6366f1; border-color: #6366f1; }
        select option { color: #000; background: #fff; }
        #id_local_inicio_jornada { display: flex; flex-direction: column; gap: 0.5rem; }
        #id_local_inicio_jornada div { display: flex; align-items: center; gap: 0.5rem; }
        #id_local_inicio_jornada label { cursor: pointer; color: #cbd5e1; }
        input[type="radio"] { width: 1.1rem; height: 1.1rem; accent-color: #10b981; }

        /* Select2 Dark */
        .select2-container { width: 100% !important; }
        .select2-container--default .select2-selection--single {
            background-color: #334155 !important; border-color: #475569 !important;
            color: #e2e8f0 !important; height: 42px; border-radius: 0.375rem; display: flex; align-items: center;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #e2e8f0 !important; line-height: 42px; padding-left: 12px;
        }
        .select2-dropdown { background-color: #1e293b !important; border-color: #475569 !important; color: #e2e8f0; }
        .select2-container--default .select2-search--dropdown .select2-search__field {
            background-color: #334155 !important; border: 1px solid #475569 !important; color: white !important;
        }
        .select2-results__option--highlighted.select2-results__option--selectable {
            background-color: #6366f1 !important; color: white !important;
        }
        .errorlist { list-style: none; padding: 0; margin: 0; }
    </style>
</head>
<body class="bg-gray-950 text-gray-200 p-4 sm:p-8 flex justify-center">

    {% if messages %}
        <div class="fixed top-5 right-5 z-50 space-y-2">
            {% for message in messages %}
                <div class="flex items-center p-4 mb-4 text-sm text-emerald-800 rounded-lg bg-emerald-50 border border-emerald-500 shadow-lg" role="alert" id="toast-message">
                    <svg class="flex-shrink-0 inline w-5 h-5 me-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/></svg>
                    <div><span class="font-medium">Sucesso!</span> {{ message }}</div>
                    <button type="button" class="ms-auto -mx-1.5 -my-1.5 bg-emerald-50 text-emerald-500 rounded-lg p-1.5 hover:bg-emerald-200 h-8 w-8 flex items-center justify-center" onclick="this.parentElement.remove()">
                        <span class="sr-only">Fechar</span><svg class="w-3 h-3" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
                    </button>
                </div>
            {% endfor %}
        </div>
        <script>setTimeout(function() { const t = document.querySelectorAll('#toast-message'); t.forEach(e => e.remove()); }, 4000);</script>
    {% endif %}

    <div class="w-full max-w-4xl">
        
        <div class="mb-6 border-b border-slate-800 pb-4 flex items-center justify-between relative">
            <div>
                <h2 class="text-3xl font-bold text-white">{{ titulo }}</h2>
                <p class="text-gray-400 text-sm">Relatório de Horas</p>
            </div>
            
            <div class="flex items-center gap-4">
                <a href="{% url 'historico_apontamentos' %}" class="text-indigo-400 hover:text-white border border-indigo-400/30 hover:border-indigo-400 bg-indigo-400/10 hover:bg-indigo-400/20 rounded-md px-4 py-2 text-sm font-medium transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" />
                    </svg>
                    Ver Histórico
                </a>

                <div class="relative group z-50">
                    <div class="h-10 w-10 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold text-lg cursor-pointer ring-2 ring-indigo-500 ring-offset-2 ring-offset-slate-900 shadow-lg hover:bg-indigo-500 transition-colors">
                        {{ user.username|slice:":1"|upper }}
                    </div>
                    
                    <div class="absolute right-0 top-full mt-2 w-48 bg-slate-800 border border-slate-700 rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform translate-y-2 group-hover:translate-y-0">
                        <div class="px-4 py-3 border-b border-slate-700">
                            <p class="text-sm text-white font-bold truncate">
                                {% if user.first_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.username }}{% endif %}
                            </p>
                            <p class="text-xs text-gray-400 truncate">Conectado</p>
                        </div>
                        
                        <a href="{% url 'configuracoes' %}" class="block w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-slate-700 hover:text-white transition-colors flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 01 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 01 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 01 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>
                            Configurações
                        </a>

                        <form method="post" action="{% url 'logout' %}">
                            {% csrf_token %}
                            <button type="submit" class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-slate-700 hover:text-red-300 rounded-b-lg transition-colors flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 015.25 2h5.5A2.25 2.25 0 0113 4.25v2a.75.75 0 001.5 0v-2A3.75 3.75 0 0010.75.5h-5.5A3.75 3.75 0 001.5 4.25v11.5A3.75 3.75 0 005.25 18h5.5a3.75 3.75 0 003.75-3.75v-2a.75.75 0 00-1.5 0v2A2.25 2.25 0 0110.75 16h-5.5A2.25 2.25 0 013 13.75V4.25z" clip-rule="evenodd" />
                                    <path fill-rule="evenodd" d="M15.353 9.47a.75.75 0 00-1.06 0l-1.75 1.75V4.75a.75.75 0 00-1.5 0v6.47l-1.75-1.75a.75.75 0 10-1.06 1.06l3 3a.75.75 0 001.06 0l3-3a.75.75 0 000-1.06z" clip-rule="evenodd" />
                                </svg>
                                Sair do Sistema
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <form method="post" class="space-y-6" id="apontamentoForm">
            {% csrf_token %}
            
            <div id="server-error-container" class="hidden">
                {% if form.non_field_errors %}
                    <div id="server-error-data">{{ form.non_field_errors }}</div>
                {% endif %}
            </div>

            <div class="bg-slate-900 rounded-xl border border-slate-800 p-6 shadow-lg relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-indigo-500"></div>
                <h3 class="text-indigo-400 font-bold mb-6 text-lg uppercase tracking-wider">Identificação</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="text-xs text-gray-400 mb-1 block">Colaborador *</label>{{ form.colaborador }}</div>
                    <div><label class="text-xs text-gray-400 mb-1 block">Cargo</label>{{ form.cargo_colaborador }}</div>
                    <div><label class="text-xs text-gray-400 mb-1 block">Data *</label>{{ form.data_apontamento }}</div>
                    <div><label class="text-xs text-white font-bold mb-1 block">Local de Trabalho *</label>{{ form.local_execucao }}</div>
                    <div class="md:col-span-2 bg-slate-800/50 p-4 rounded border border-slate-700">
                        <div class="flex items-center gap-3">
                            {{ form.registrar_veiculo }}
                            <label for="{{ form.registrar_veiculo.id_for_label }}" class="font-bold text-sm cursor-pointer select-none">Adicionar veículo</label>
                        </div>
                        <div id="veiculo-container" class="hidden mt-3 space-y-3">
                            <div><label class="text-xs text-gray-400 mb-1 block">Selecione o Veículo</label>{{ form.veiculo_selecao }}</div>
                            <div id="novo-veiculo-container" class="hidden grid grid-cols-2 gap-4 border-l-2 border-indigo-500 pl-3 mt-2 bg-slate-800 p-2 rounded">
                                <div><label class="text-xs text-indigo-400 block mb-1">Modelo (Ex: HB20) *</label>{{ form.veiculo_manual_modelo }}</div>
                                <div>
                                    <label class="text-xs text-indigo-400 block mb-1">Placa (7 dígitos) *</label>
                                    {{ form.veiculo_manual_placa }}
                                    {% if form.veiculo_manual_placa.errors %}<p class="text-red-400 text-xs">{{ form.veiculo_manual_placa.errors }}</p>{% endif %}
                                </div>
                            </div>
                            {% if form.veiculo_selecao.errors %}<p class="text-red-400 text-xs mt-1">{{ form.veiculo_selecao.errors }}</p>{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {# NOTA: Este container agora abriga o wrapper de inputs e o wrapper do tangerino #}
            <div id="container-obra" class="hidden bg-slate-900 rounded-xl border border-slate-800 p-6 shadow-lg relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-emerald-500"></div>
                <h3 class="text-emerald-400 font-bold mb-6 text-lg uppercase tracking-wider">Dados da Obra</h3>
                
                <div id="inputs-obra-wrapper" class="bg-slate-800/50 p-4 rounded-lg border border-slate-700 mb-6">
                    <p class="text-xs text-yellow-500 font-bold mb-2 uppercase">Código do Cliente apenas setores que não possuirem o adendo</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="text-xs text-emerald-300 mb-1 block font-bold">Código da Obra (com adendo)</label>
                            {{ form.projeto }}
                            <p class="text-[10px] text-gray-500 mt-1">Ex: R1894A00 - Vintage...</p>
                        </div>
                        <div>
                            <label class="text-xs text-blue-300 mb-1 block font-bold">Código do Cliente (Geral)</label>
                            {{ form.codigo_cliente }}
                            <p class="text-[10px] text-gray-500 mt-1">Ex: 1894 - Vintage...</p>
                        </div>
                    </div>
                </div>

                <div id="insertion-point-obra" class="mt-6"></div>
                
                <div id="tangerino-wrapper" class="mt-6 pt-6 border-t border-slate-800">
                    <div class="bg-slate-800/80 p-4 rounded border border-emerald-700/50">
                        <label class="font-bold text-sm text-white mb-3 block">Início da jornada (primeiro ponto no Tangerino) *</label>
                        <div class="pl-2">{{ form.local_inicio_jornada }}</div>
                        <div id="tangerino-outros-container" class="hidden mt-3 pl-2 border-l-2 border-emerald-500">
                            <label class="text-xs text-emerald-400 block mb-1">Especifique o Local *</label>{{ form.local_inicio_jornada_outros }}
                        </div>
                    </div>
                </div>
            </div>

            <div id="container-fora" class="hidden bg-slate-900 rounded-xl border border-slate-800 p-6 shadow-lg relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-orange-500"></div>
                <h3 class="text-orange-400 font-bold mb-6 text-lg uppercase tracking-wider">Fora da Obra</h3>
                <div class="mb-6"><label class="text-xs text-orange-400 font-bold mb-1 block">Setor / Justificativa (Custo) *</label>{{ form.centro_custo }}</div>
                
                <div id="dynamic-obra-injection"></div>

                <div id="insertion-point-fora"></div>
            </div>

            <div id="common-fields-block" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="text-xs text-gray-400 mb-1 block">Hora Início *</label>{{ form.hora_inicio }}</div>
                    <div><label class="text-xs text-gray-400 mb-1 block">Hora Término *</label>{{ form.hora_termino }}</div>
                    <div class="md:col-span-2 bg-slate-800/50 p-4 rounded border border-slate-700 mt-2">
                        <div class="flex items-center gap-3">
                            {{ form.registrar_auxiliar }}
                            <label for="{{ form.registrar_auxiliar.id_for_label }}" class="font-bold text-sm text-indigo-300 cursor-pointer">Adicionar Auxiliares?</label>
                        </div>
                        <div class="aux-wrapper hidden space-y-3 mt-3">
                            <div><label class="text-xs text-gray-500 block mb-1">Auxiliar Principal</label>{{ form.auxiliar_selecao }}</div>
                            {{ form.auxiliares_extras_list }}
                            <div id="extras-container" class="space-y-2"></div>
                            <button type="button" id="btn-add-extra" class="text-xs text-indigo-400 font-bold hover:text-white transition-colors">+ Add. Auxiliar</button>
                        </div>
                    </div>
                    <div class="md:col-span-2"><label class="text-xs text-gray-400 mb-1 block">Ocorrências / Obs.</label>{{ form.ocorrencias }}</div>
                </div>
            </div>

            <div class="flex justify-end pt-4">
                <button type="button" id="btn-pre-save" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg w-full md:w-auto transition-colors">Salvar Registro</button>
            </div>
        </form>
    </div>

    <div id="confirm-modal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900/80 transition-opacity backdrop-blur-sm"></div>
        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-xl bg-slate-800 border border-slate-700 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <div class="bg-slate-900 px-4 py-3 sm:px-6 border-b border-slate-700 flex items-center gap-3">
                        <div id="modal-icon-container" class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-indigo-900/50"></div>
                        <h3 class="text-lg font-semibold leading-6 text-white" id="modal-title">Confirmação</h3>
                    </div>
                    <div class="px-4 py-5 sm:p-6"><div id="modal-content" class="space-y-3 text-sm text-gray-300"></div></div>
                    <div class="bg-slate-700/30 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 gap-3">
                        <button type="button" id="btn-confirm-submit" class="hidden inline-flex w-full justify-center rounded-md bg-emerald-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 sm:w-auto">Confirmar e Enviar</button>
                        <button type="button" onclick="closeConfirmModal()" class="mt-3 inline-flex w-full justify-center rounded-md bg-slate-700 px-3 py-2 text-sm font-semibold text-gray-300 shadow-sm hover:bg-slate-600 sm:mt-0 sm:w-auto border border-slate-600">Voltar e Editar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Inicialização Select2
            $('#id_colaborador').select2({ placeholder: "Pesquisar Colaborador..." });
            $('#id_veiculo_selecao').select2({ placeholder: "Pesquisar Veículo..." });
            $('#id_projeto').select2({ placeholder: "Pesquisar Código Específico...", allowClear: true });
            $('#id_codigo_cliente').select2({ placeholder: "Pesquisar Código do Cliente...", allowClear: true });
            $('#id_centro_custo').select2({ placeholder: "Pesquisar Centro de Custo / Justificativa..." });
            $('#id_auxiliar_selecao').select2({ placeholder: "Pesquisar Auxiliar..." });
            
            // Lógica de Exclusividade (Obra vs Cliente)
            $('#id_projeto').on('select2:select', function (e) {
                $('#id_codigo_cliente').val(null).trigger('change'); 
            });
            $('#id_codigo_cliente').on('select2:select', function (e) {
                $('#id_projeto').val(null).trigger('change'); 
            });
            
            // Re-render Select2 ao mudar visibilidade
            $('#id_local_execucao').change(function() { 
                setTimeout(function() { 
                    $('#id_projeto').select2(); 
                    $('#id_codigo_cliente').select2(); 
                    $('#id_centro_custo').select2(); 
                }, 100); 
            });
            
            // Veículo Manual Toggle
            $('#id_veiculo_selecao').on('select2:select', function(e) {
                const val = e.params.data.id; toggleNovoVeiculo(val);
            });
            toggleNovoVeiculo($('#id_veiculo_selecao').val());
            function toggleNovoVeiculo(val) {
                const novoContainer = $('#novo-veiculo-container');
                if(val === 'OUTRO') { novoContainer.removeClass('hidden'); } else { novoContainer.addClass('hidden'); $('#id_veiculo_manual_modelo').val(''); $('#id_veiculo_manual_placa').val(''); }
            }

            // --- LÓGICA DINÂMICA DE OBRA EXTERNA ---
            $('#id_centro_custo').on('select2:select', function(e) {
                const val = e.params.data.id;
                checkCentroCusto(val);
            });

            // Se for edição e já tiver valor, roda ao carregar
            const initialCC = $('#id_centro_custo').val();
            if(initialCC) checkCentroCusto(initialCC);

            async function checkCentroCusto(id) {
                if(!id) return;
                try {
                    // Consulta API para saber se permite alocação
                    const r = await fetch(`/produtividade/api/get-centro-custo-info/${id}/`);
                    const d = await r.json();
                    
                    const inputsWrapper = document.getElementById('inputs-obra-wrapper');
                    const injectionPoint = document.getElementById('dynamic-obra-injection');
                    const originalParent = document.querySelector('#container-obra'); // Onde ele fica originalmente

                    if (d.permite_alocacao) {
                        // Move os inputs para dentro do container EXTERNO
                        injectionPoint.appendChild(inputsWrapper);
                        // Re-inicializa select2 pois mover elementos no DOM pode quebrar
                        $('#id_projeto').select2({ placeholder: "Pesquisar Código Específico...", allowClear: true });
                        $('#id_codigo_cliente').select2({ placeholder: "Pesquisar Código do Cliente...", allowClear: true });
                    } else {
                        // Devolve para o container INT (Original) e limpa valores
                        // Insere antes do insertion-point-obra para manter ordem
                        const ref = document.getElementById('insertion-point-obra');
                        originalParent.insertBefore(inputsWrapper, ref);
                        
                        // Se estamos em modo EXT e não permite alocação, limpa os campos visualmente
                        if ($('#id_local_execucao').val() === 'EXT') {
                            $('#id_projeto').val(null).trigger('change');
                            $('#id_codigo_cliente').val(null).trigger('change');
                        }
                    }
                } catch(e) { console.error(e); }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const placaInput = document.getElementById('id_veiculo_manual_placa');
            if(placaInput) { placaInput.addEventListener('input', function() { this.value = this.value.toUpperCase(); }); }

            const localSel = document.getElementById('id_local_execucao');
            const boxObra = document.getElementById('container-obra');
            const boxFora = document.getElementById('container-fora');
            const commonBlock = document.getElementById('common-fields-block');
            const insertObra = document.getElementById('insertion-point-obra');
            const insertFora = document.getElementById('insertion-point-fora');
            const inputsWrapper = document.getElementById('inputs-obra-wrapper');

            function updateLayout() {
                const val = localSel.value;
                commonBlock.classList.remove('hidden');
                
                if(val === 'INT') { 
                    // Modo INT: Mostra container obra completo (Tangerino + Inputs)
                    boxObra.classList.remove('hidden'); 
                    boxFora.classList.add('hidden'); 
                    insertObra.appendChild(commonBlock); 
                    
                    // Garante que inputs de obra voltem para cá
                    const ref = document.getElementById('insertion-point-obra');
                    boxObra.insertBefore(inputsWrapper, ref);
                } 
                else { 
                    // Modo EXT: Esconde container Obra (Tangerino), Mostra Fora
                    boxObra.classList.add('hidden'); 
                    boxFora.classList.remove('hidden'); 
                    insertFora.appendChild(commonBlock); 
                    
                    // O checkCentroCusto irá decidir se move os inputs para cá ou não
                }
            }
            if(localSel) { localSel.addEventListener('change', updateLayout); setTimeout(updateLayout, 50); }

            // ... (Restante do código JS igual: Radios Tangerino, Check Veículo, Auxiliares) ...
            const radios = document.querySelectorAll('input[name="local_inicio_jornada"]');
            const outrosContainer = document.getElementById('tangerino-outros-container');
            radios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'OUT') { outrosContainer.classList.remove('hidden'); } 
                    else { outrosContainer.classList.add('hidden'); document.getElementById('id_local_inicio_jornada_outros').value = ''; }
                });
            });
            const vCheck = document.getElementById('id_registrar_veiculo');
            const vCont = document.getElementById('veiculo-container');
            if(vCheck) vCheck.addEventListener('change', () => vCheck.checked ? vCont.classList.remove('hidden') : vCont.classList.add('hidden'));
            
            const auxCheck = document.getElementById('id_registrar_auxiliar');
            const auxWrap = document.querySelector('.aux-wrapper');
            const mainAux = document.getElementById('id_auxiliar_selecao');
            const btnAddExtra = document.getElementById('btn-add-extra');
            const containerExtras = document.getElementById('extras-container');
            const hiddenList = document.getElementById('id_auxiliares_extras_list');
            if(auxCheck) {
                const toggleAux = () => {
                    if(auxCheck.checked) { auxWrap.classList.remove('hidden'); if(mainAux.options.length <= 1) loadAuxs(mainAux); } else { auxWrap.classList.add('hidden'); }
                };
                auxCheck.addEventListener('change', toggleAux); toggleAux();
            }
            async function loadAuxs(selectElement) {
                try {
                    const r = await fetch('/produtividade/api/get-auxiliares/');
                    const d = await r.json();
                    selectElement.innerHTML = '<option value="">Selecione...</option>';
                    d.auxiliares.forEach(aux => {
                        const option = document.createElement('option');
                        option.value = aux.id; option.textContent = aux.nome; selectElement.appendChild(option);
                    });
                } catch(e) {}
            }
            if(btnAddExtra) {
                btnAddExtra.addEventListener('click', async () => {
                    const newSel = document.createElement('select'); newSel.className = "form-control mt-2 text-sm"; await loadAuxs(newSel);
                    const div = document.createElement('div'); div.className = "flex items-center gap-2";
                    const btnRemove = document.createElement('button'); btnRemove.type = "button"; btnRemove.innerHTML = "&times;"; btnRemove.className = "text-red-500 font-bold px-2 text-xl hover:text-red-400";
                    newSel.addEventListener('change', updateHidden); btnRemove.addEventListener('click', () => { div.remove(); updateHidden(); });
                    div.append(newSel, btnRemove); containerExtras.appendChild(div);
                });
            }
            function updateHidden() {
                const selects = containerExtras.querySelectorAll('select');
                const vals = Array.from(selects).map(s => s.value).filter(v=>v);
                hiddenList.value = vals.join(',');
            }
            $('#id_colaborador').on('select2:select', async function (e) {
                const val = e.params.data.id; if(val) { const r = await fetch(`/produtividade/api/get-colaborador-info/${val}/`); const d = await r.json(); document.getElementById('id_cargo_colaborador').value = d.cargo; }
            });

            // --- LÓGICA DE SALVAMENTO (Modal) ---
            const btnPreSave = document.getElementById('btn-pre-save');
            const modal = document.getElementById('confirm-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalIconContainer = document.getElementById('modal-icon-container');
            const btnConfirmSubmit = document.getElementById('btn-confirm-submit');
            const mainForm = document.getElementById('apontamentoForm');
            window.closeConfirmModal = function() { modal.classList.add('hidden'); }
            function formatDate(dateStr) { if(!dateStr) return ""; const [y, m, d] = dateStr.split('-'); return `${d}-${m}-${y}`; }
            function getTangerinoIcon(code) {
                if(code === 'RES') return '<svg class="h-5 w-5 text-blue-400 inline" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg> Residência';
                if(code === 'CLI') return '<svg class="h-5 w-5 text-orange-400 inline" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg> Cliente';
                if(code === 'SED') return '<svg class="h-5 w-5 text-purple-400 inline" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd" /></svg> Sede ATGB';
                if(code === 'OUT') return '<svg class="h-5 w-5 text-yellow-400 inline" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg> Outros';
                return "";
            }

            btnPreSave.addEventListener('click', function() {
                const data = {
                    colab: $('#id_colaborador').select2('data')[0]?.text || "",
                    colab_id: $('#id_colaborador').val(),
                    data_pt: document.getElementById('id_data_apontamento').value,
                    local: document.getElementById('id_local_execucao').value,
                    obra: $('#id_projeto').select2('data')[0]?.text || "",
                    obra_id: $('#id_projeto').val(),
                    cliente_txt: $('#id_codigo_cliente').select2('data')[0]?.text || "",
                    cliente_id: $('#id_codigo_cliente').val(),
                    tangerino: document.querySelector('input[name="local_inicio_jornada"]:checked')?.value,
                    tangerino_outros: document.getElementById('id_local_inicio_jornada_outros').value,
                    centro_custo_txt: $('#id_centro_custo').select2('data')[0]?.text || "",
                    centro_custo_id: $('#id_centro_custo').val(),
                    inicio: document.getElementById('id_hora_inicio').value,
                    fim: document.getElementById('id_hora_termino').value,
                    usou_veiculo: document.getElementById('id_registrar_veiculo').checked,
                    veiculo_id: $('#id_veiculo_selecao').val(),
                    veiculo_txt: $('#id_veiculo_selecao').select2('data')[0]?.text,
                    veiculo_novo_mod: document.getElementById('id_veiculo_manual_modelo').value,
                    veiculo_novo_pla: document.getElementById('id_veiculo_manual_placa').value,
                    usou_aux: document.getElementById('id_registrar_auxiliar').checked,
                    aux_princ: $('#id_auxiliar_selecao').select2('data')[0]?.text
                };

                // Lógica de erros simplificada para o contexto
                let errors = [];
                if(!data.colab_id) errors.push("Colaborador é obrigatório.");
                if(!data.data_pt) errors.push("Data é obrigatória.");
                if(!data.inicio) errors.push("Hora de Início é obrigatória.");
                if(!data.fim) errors.push("Hora de Término é obrigatória.");

                if(data.local === 'INT') {
                    if(!data.obra_id && !data.cliente_id) errors.push("Selecione o Código da Obra OU o Código do Cliente.");
                    if(data.obra_id && data.cliente_id) errors.push("Selecione APENAS UM (Obra ou Cliente), não ambos.");
                    if(!data.tangerino) errors.push("Início da jornada (Tangerino) é obrigatório.");
                } else {
                    if(!data.centro_custo_id) errors.push("Centro de Custo / Justificativa é obrigatório.");
                    
                    // Validação visual: Se o campo de obra estiver visível no container externo, ele deve ser validado?
                    // Como não temos acesso síncrono à flag 'permite_alocacao' aqui facilmente sem chamar API de novo,
                    // confiamos na presença visual do valor. Se o usuário preencheu Obra E Centro de Custo, ok.
                    
                    // Nota: A validação rigorosa ocorre no backend (Clean do Form).
                }

                if(errors.length > 0) {
                    modalIconContainer.className = "mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-900/50 sm:mx-0 sm:h-10 sm:w-10";
                    modalIconContainer.innerHTML = `<svg class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`;
                    modalTitle.textContent = "Dados Incompletos";
                    modalTitle.classList.remove('text-emerald-400'); modalTitle.classList.add('text-red-400');
                    let errorHtml = `<p class="font-bold text-red-300 mb-2">Correções necessárias:</p><ul class="list-disc list-inside space-y-1 text-gray-400">`;
                    errors.forEach(e => errorHtml += `<li>${e}</li>`);
                    errorHtml += `</ul>`;
                    modalContent.innerHTML = errorHtml;
                    btnConfirmSubmit.classList.add('hidden');
                } else {
                    modalIconContainer.className = "mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-emerald-900/50 sm:mx-0 sm:h-10 sm:w-10";
                    modalIconContainer.innerHTML = `<svg class="h-6 w-6 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                    modalTitle.textContent = "Confirmação de Envio";
                    modalTitle.classList.remove('text-red-400'); modalTitle.classList.add('text-emerald-400');

                    let contextInfo = "";
                    if(data.local === 'INT') {
                        if(data.obra_id) contextInfo = `<span class="text-indigo-300 font-bold">Obra:</span> ${data.obra}`;
                        else contextInfo = `<span class="text-blue-300 font-bold">Cliente Geral:</span> ${data.cliente_txt}`;
                    } else {
                        contextInfo = `<span class="text-orange-300 font-bold">Centro Custo:</span> ${data.centro_custo_txt}`;
                        // Se tiver obra preenchida mesmo sendo Externo
                        if(data.obra_id) contextInfo += `<br><span class="text-indigo-300 font-bold text-xs pl-2">↳ Alocado na Obra:</span> ${data.obra}`;
                    }
                    
                    // ... (Restante da montagem do HTML do modal igual) ...
                    let html = `<div class="bg-slate-900 p-4 rounded-lg border border-slate-700 space-y-2 text-sm">
                        <p><span class="text-gray-500">Colaborador:</span> <span class="text-white font-bold text-lg block">${data.colab}</span></p>
                        <p><span class="text-gray-500">Data:</span> <span class="text-white font-bold">${formatDate(data.data_pt)}</span></p>
                        <div class="py-2 border-y border-slate-700 my-2 space-y-1"><p>${contextInfo}</p></div>
                        <p><span class="text-gray-500">Horário:</span> <span class="text-emerald-400 font-mono font-bold text-base">${data.inicio}</span> até <span class="text-red-400 font-mono font-bold text-base">${data.fim}</span></p>
                        </div>`;
                    modalContent.innerHTML = html;
                    btnConfirmSubmit.classList.remove('hidden');
                }
                modal.classList.remove('hidden');
            });

            btnConfirmSubmit.addEventListener('click', function(e) { 
                e.preventDefault(); 
                const formData = new FormData(mainForm);
                btnConfirmSubmit.textContent = "Enviando...";
                btnConfirmSubmit.disabled = true;

                fetch(window.location.href, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => { if (response.redirected) { window.location.href = response.url; return; } return response.text().then(html => ({ html, url: response.url })); })
                .then(result => {
                    if (!result) return;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(result.html, 'text/html');
                    const errorDiv = doc.querySelector('#server-error-data');
                    if (errorDiv) {
                        const errorMsg = errorDiv.innerHTML;
                        modalIconContainer.className = "mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-900/50 sm:mx-0 sm:h-10 sm:w-10";
                        modalIconContainer.innerHTML = `<svg class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`;
                        modalTitle.textContent = "Erro no Registro";
                        modalTitle.classList.remove('text-emerald-400'); modalTitle.classList.add('text-red-400');
                        modalContent.innerHTML = `<div class="text-red-300 bg-red-900/20 p-3 rounded border border-red-800">${errorMsg}</div>`;
                        btnConfirmSubmit.classList.add('hidden'); btnConfirmSubmit.textContent = "Confirmar e Enviar"; btnConfirmSubmit.disabled = false;
                    } else { document.open(); document.write(result.html); document.close(); }
                })
                .catch(err => { alert("Erro de comunicação."); btnConfirmSubmit.disabled = false; btnConfirmSubmit.textContent = "Confirmar e Enviar"; });
            });
        });
    </script>
</body>
</html>